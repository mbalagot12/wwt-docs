name: Local CI/CD Testing

on:
  push:
    branches: [test-ci-cd]  # ONLY test branch - NEVER main!
  pull_request:
    branches: [test-ci-cd]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  local-ci-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ›¡ï¸ Safety Check - Prevent Production Deploy
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "âŒ ERROR: This workflow should NEVER run on main branch!"
            echo "This is a LOCAL TESTING workflow only."
            exit 1
          fi
          echo "âœ… Safety check passed - running on test branch"

      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: âš¡ Install UV
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: ğŸ”§ Set up UV environment
        run: |
          uv venv .venv
          echo "VIRTUAL_ENV=.venv" >> $GITHUB_ENV
          echo "PATH=.venv/bin:$PATH" >> $GITHUB_ENV

      - name: ğŸ“¦ Install dependencies
        run: uv pip install -r requirements.txt

      - name: ğŸ—ï¸ Test Build Process
        run: |
          echo "ğŸš€ Testing MkDocs build..."
          mkdocs build
          echo "âœ… Build completed successfully"

      - name: ğŸ” Validate Build Output
        run: |
          echo "ğŸ” Validating build output..."
          
          # Check if site directory exists
          if [ ! -d "site" ]; then
            echo "âŒ ERROR: site directory not found"
            exit 1
          fi
          
          # Check if main files exist
          if [ ! -f "site/index.html" ]; then
            echo "âŒ ERROR: index.html not found"
            exit 1
          fi
          
          # Check site size
          SITE_SIZE=$(du -sm site | cut -f1)
          if [ "$SITE_SIZE" -lt 1 ]; then
            echo "âŒ ERROR: Site too small ($SITE_SIZE MB)"
            exit 1
          fi
          
          echo "âœ… Build validation passed (Size: ${SITE_SIZE}MB)"

      - name: ğŸ“„ Test Content Structure
        run: |
          echo "ğŸ“„ Testing content structure..."
          
          # Test agenda page specifically
          if [ -f "site/references/agenda/index.html" ]; then
            if grep -q "Campus Workshop Agenda" "site/references/agenda/index.html"; then
              echo "âœ… Agenda content validated"
            else
              echo "âŒ Agenda content validation failed"
              exit 1
            fi
          else
            echo "âš ï¸ Agenda page not found (may be normal if not in nav)"
          fi
          
          echo "âœ… Content structure validated"

      - name: ğŸŒ Test Local Server Simulation
        run: |
          echo "ğŸŒ Testing local server simulation..."
          
          # Start server in background
          cd site
          python -m http.server 8000 &
          SERVER_PID=$!
          cd ..
          
          # Wait for server to start
          sleep 5
          
          # Test server response
          if curl -f -s "http://localhost:8000/" > /dev/null; then
            echo "âœ… Local server test passed"
          else
            echo "âŒ Local server test failed"
            kill $SERVER_PID 2>/dev/null || true
            exit 1
          fi
          
          # Clean up
          kill $SERVER_PID 2>/dev/null || true
          echo "âœ… Server simulation completed"

      - name: â±ï¸ Performance Testing
        run: |
          echo "â±ï¸ Testing build performance..."
          
          # Time the build process
          START_TIME=$(date +%s)
          mkdocs build
          END_TIME=$(date +%s)
          BUILD_TIME=$((END_TIME - START_TIME))
          
          echo "ğŸ“Š Build completed in ${BUILD_TIME} seconds"
          
          if [ $BUILD_TIME -lt 60 ]; then
            echo "âœ… Build time acceptable"
          else
            echo "âš ï¸ Build time may be slow for CI/CD"
          fi

      - name: ğŸ§ª Run Local Test Script
        run: |
          echo "ğŸ§ª Running comprehensive local tests..."
          chmod +x scripts/local-ci-test.sh
          ./scripts/local-ci-test.sh

      - name: ğŸ“Š Test Summary
        run: |
          echo "## ğŸ§ª Local CI/CD Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Tests Completed Successfully:" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Process**: MkDocs build successful" >> $GITHUB_STEP_SUMMARY
          echo "- **Content Validation**: All required pages present" >> $GITHUB_STEP_SUMMARY
          echo "- **Server Simulation**: Local server accessible" >> $GITHUB_STEP_SUMMARY
          echo "- **Performance**: Build time acceptable" >> $GITHUB_STEP_SUMMARY
          echo "- **Safety**: No production deployment attempted" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ›¡ï¸ Safety Guarantees:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Only runs on test-ci-cd branch" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… No server deployment attempted" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… No production site modifications" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Completely isolated testing" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸš€ Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "Ready for staging environment testing when approved." >> $GITHUB_STEP_SUMMARY

      - name: ğŸ‰ Success Notification
        run: |
          echo "ğŸ‰ LOCAL CI/CD TESTING COMPLETED SUCCESSFULLY!"
          echo ""
          echo "âœ… All tests passed"
          echo "ğŸ›¡ï¸ No production systems affected"
          echo "ğŸš€ Ready for next phase when you approve"
